pipeline {
  agent {
    docker {
      image 'docker.artifactory.tools.vsware.ie/ci-runner-python-build-container'
      registryUrl 'https://docker.artifactory.tools.vsware.ie'
    }
  }
    stages {
      stage('Checkout'){
        steps {
          sh 'echo Checkout AWS Functions'
          echo 'test checkout'
        }
      }

      stage("Setting Up Environment"){
        steps {
          sh """
            echo "=============== STOPPING ENVIRONMENT ==========================="

            echo "BUILD_RELEASE_NUMBER=1.0-LATEST" > env.properties

            echo "++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++"
            echo "setting up python environment"

            if [ ! -d $WORKSPACE/venv ]; then
              python3 -m venv $WORKSPACE/venv
              source $WORKSPACE/venv/bin/activate
              pip install boto3
            fi

            echo "++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++"
          """
        }
      }

      stage('Shutting down Dev Environment'){
        steps {
          sh """
            echo "running script"

            source $WORKSPACE/venv/bin/activate
            echo "before"
            JSON='{"env":"no_preprod","action":"stop"}'
            echo "middle"
            python print $JSON
            echo "end"
        """
        }
      }
    }

    post {
      always {
        deleteDir()
      }
    }
}
